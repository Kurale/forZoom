<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á + –≠–∫—Å–ø–æ—Ä—Ç</title>
    <style>
        :root { --primary: #3498db; --secondary: #2c3e50; --accent: #e67e22; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--secondary); padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--secondary); margin-bottom: 30px; }
        
        /* Controls */
        .controls-group { margin-bottom: 20px; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; margin: 0 5px; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-gen:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-exp { background: var(--accent); color: white; display: none; } /* –°–∫—Ä—ã—Ç—ã –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */
        .btn-exp:hover { background: #d35400; }
        
        /* Select styles */
        select.btn {
            background: white;
            color: var(--secondary);
            border: 2px solid var(--primary);
            min-width: 180px;
        }
        select.btn:hover {
            background: #f8f9fa;
        }
        select.btn:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        label {
            font-weight: 600;
            color: var(--secondary);
        }

        /* Loading State */
        #loading { text-align: center; font-style: italic; color: #7f8c8d; margin-top: 50px; }

        /* Task Area */
        #appContent { display: none; } /* –°–∫—Ä—ã—Ç –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ JSON */
        .task-card { border-left: 5px solid var(--primary); background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; font-size: 1.1rem; }
        
        /* Visualization */
        .canvas-container { text-align: center; margin: 20px 0; border: 1px solid #eee; padding: 10px; background: white; }
        #taskSvg { width: 100%; height: auto; max-height: 200px; background: white; }
        .arrow-head { fill: var(--secondary); }
        .diagram-text { font-size: 14px; font-family: sans-serif; fill: var(--secondary); }
        .distance-line { stroke: var(--accent); stroke-width: 2; stroke-dasharray: 5,5; }

        /* Answer Section */
        .answer-section { border-top: 2px solid #eee; padding-top: 20px; display: flex; align-items: center; gap: 10px; }
        input[type=number] { padding: 8px; width: 80px; border: 2px solid #ddd; border-radius: 5px; text-align: center; font-size: 1rem; }
        .feedback { font-weight: bold; margin-left: 15px; }
        .feedback.correct { color: #27ae60; }
        .feedback.wrong { color: #c0392b; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ</h1>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>

    <div id="appContent">
        <div class="controls-group">
            <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">
                <label for="taskType">–¢–∏–ø –∑–∞–¥–∞—á–∏:</label>
                <select id="taskType" class="btn">
                    <option value="meeting">–ù–∞–≤—Å—Ç—Ä–µ—á—É</option>
                    <option value="opposite">–í —Å—Ç–æ—Ä–æ–Ω—ã</option>
                    <option value="same">–í–¥–æ–≥–æ–Ω–∫—É</option>
                    <option value="ratio">–ß–µ—Ä–µ–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</option>
                </select>
                
                <label for="unknownVar">–ù–∞–π—Ç–∏:</label>
                <select id="unknownVar" class="btn">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
                
                <button class="btn btn-gen" onclick="ui.generate()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div id="taskText" class="task-card">
            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É.
        </div>
        
        <div class="canvas-container">
             <svg id="taskSvg" viewBox="0 0 600 200" xmlns="http://www.w3.org/2000/svg">
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ccc">–°—Ö–µ–º–∞ –∑–∞–¥–∞—á–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</text>
            </svg>
        </div>

        <div class="controls-group" id="exportControls">
            <button class="btn btn-exp" onclick="exporter.saveSVG()">üíæ –°–∫–∞—á–∞—Ç—å SVG</button>
            <button class="btn btn-exp" onclick="exporter.savePNG()">üñºÔ∏è –°–∫–∞—á–∞—Ç—å PNG</button>
        </div>

        <div class="answer-section">
            <label for="userAnswer">–û—Ç–≤–µ—Ç:</label>
            <input type="number" id="userAnswer"> <span id="unitDisplay"></span>
            <button class="btn btn-gen" onclick="ui.check()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <span id="feedback" class="feedback"></span>
        </div>
    </div>
</div>

<canvas id="pngCanvas" width="600" height="200" style="display:none;"></canvas>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
let ACTORS_DB = [];
let currentTaskData = null;

/**
 * 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
 */
async function initApp() {
    try {
        const response = await fetch('actors.json');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON');
        ACTORS_DB = await response.json();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.getElementById('loading').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
    } catch (error) {
        document.getElementById('loading').innerHTML = `–û—à–∏–±–∫–∞: ${error.message}.<br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª–∏ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.`;
        document.getElementById('loading').style.color = 'red';
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    initApp();
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö
    ui.updateUnknownOptions();
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
    document.getElementById('taskType').addEventListener('change', ui.updateUnknownOptions.bind(ui));
});


/**
 * 2. –î–í–ò–ñ–û–ö –ì–ï–ù–ï–†–ê–¶–ò–ò
 */
const engine = {
    random(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },
    pick(arr) { return arr[this.random(0, arr.length - 1)]; },

    // –°—Ü–µ–Ω–∞—Ä–∏–∏ (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å, –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤)
    meeting(a, b, unknown = 't') {
        const v1 = this.random(a.speed.min, a.speed.max);
        const v2 = this.random(b.speed.min, b.speed.max);
        const t = this.random(2, 5);
        const S = (v1 + v2) * t;

        let text, answer, unit, unknownVar;

        switch(unknown) {
            case 't':
                text = `–ò–∑ –¥–≤—É—Ö –ø—É–Ω–∫—Ç–æ–≤, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–æ—Ç–æ—Ä—ã–º–∏ <b>${S} –∫–º</b>, –≤—ã–µ—Ö–∞–ª–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –¥—Ä—É–≥ –¥—Ä—É–≥—É ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ ‚Äî <b>${v1} –∫–º/—á</b>, –≤—Ç–æ—Ä–æ–≥–æ ‚Äî <b>${v2} –∫–º/—á</b>. –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è?`;
                answer = t;
                unit = "—á.";
                unknownVar = 't';
                break;
            case 'S':
                text = `${a.labels.cap} –∏ ${b.labels.nom} –≤—ã–µ—Ö–∞–ª–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –¥—Ä—É–≥ –¥—Ä—É–≥—É –∏–∑ –¥–≤—É—Ö –ø—É–Ω–∫—Ç–æ–≤. –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ ‚Äî <b>${v1} –∫–º/—á</b>, –≤—Ç–æ—Ä–æ–≥–æ ‚Äî <b>${v2} –∫–º/—á</b>. –û–Ω–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ <b>${t} —á</b>. –ö–∞–∫–æ–≤–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏?`;
                answer = S;
                unit = "–∫–º";
                unknownVar = 'S';
                break;
            case 'v1':
                text = `–ò–∑ –¥–≤—É—Ö –ø—É–Ω–∫—Ç–æ–≤, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–æ—Ç–æ—Ä—ã–º–∏ <b>${S} –∫–º</b>, –≤—ã–µ—Ö–∞–ª–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –¥—Ä—É–≥ –¥—Ä—É–≥—É ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ ‚Äî <b>${v2} –∫–º/—á</b>, –∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ <b>${t} —á</b>. –ù–∞–π–¥–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ.`;
                answer = v1;
                unit = "–∫–º/—á";
                unknownVar = 'v1';
                break;
            case 'v2':
                text = `–ò–∑ –¥–≤—É—Ö –ø—É–Ω–∫—Ç–æ–≤, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–æ—Ç–æ—Ä—ã–º–∏ <b>${S} –∫–º</b>, –≤—ã–µ—Ö–∞–ª–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –¥—Ä—É–≥ –¥—Ä—É–≥—É ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ ‚Äî <b>${v1} –∫–º/—á</b>, –∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ <b>${t} —á</b>. –ù–∞–π–¥–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ.`;
                answer = v2;
                unit = "–∫–º/—á";
                unknownVar = 'v2';
                break;
        }

        return {
            type: 'meeting',
            actors: { a, b },
            values: { v1, v2, S, t },
            unknownVar,
            text,
            answer,
            unit
        };
    },

    opposite(a, b, unknown = 'S') {
        const v1 = this.random(a.speed.min, a.speed.max);
        const v2 = this.random(b.speed.min, b.speed.max);
        const t = this.random(2, 5);
        const S = (v1 + v2) * t;

        let text, answer, unit, unknownVar;

        switch(unknown) {
            case 'S':
                text = `–ò–∑ –æ–¥–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å ${a.labels.gen} ‚Äî <b>${v1} –∫–º/—á</b>, ${b.labels.gen} ‚Äî <b>${v2} –∫–º/—á</b>. –ö–∞–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±—É–¥–µ—Ç –º–µ–∂–¥—É –Ω–∏–º–∏ —á–µ—Ä–µ–∑ <b>${t} —á</b>?`;
                answer = S;
                unit = "–∫–º";
                unknownVar = 'S';
                break;
            case 't':
                text = `–ò–∑ –æ–¥–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å ${a.labels.gen} ‚Äî <b>${v1} –∫–º/—á</b>, ${b.labels.gen} ‚Äî <b>${v2} –∫–º/—á</b>. –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏ –±—É–¥–µ—Ç <b>${S} –∫–º</b>?`;
                answer = t;
                unit = "—á.";
                unknownVar = 't';
                break;
            case 'v1':
                text = `–ò–∑ –æ–¥–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å ${b.labels.gen} ‚Äî <b>${v2} –∫–º/—á</b>. –ß–µ—Ä–µ–∑ <b>${t} —á</b> —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏ —Å—Ç–∞–ª–æ <b>${S} –∫–º</b>. –ù–∞–π–¥–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å ${a.labels.gen}.`;
                answer = v1;
                unit = "–∫–º/—á";
                unknownVar = 'v1';
                break;
            case 'v2':
                text = `–ò–∑ –æ–¥–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å ${a.labels.nom} –∏ ${b.labels.nom}. –°–∫–æ—Ä–æ—Å—Ç—å ${a.labels.gen} ‚Äî <b>${v1} –∫–º/—á</b>. –ß–µ—Ä–µ–∑ <b>${t} —á</b> —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏ —Å—Ç–∞–ª–æ <b>${S} –∫–º</b>. –ù–∞–π–¥–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å ${b.labels.gen}.`;
                answer = v2;
                unit = "–∫–º/—á";
                unknownVar = 'v2';
                break;
        }

        return {
            type: 'opposite',
            actors: { a, b },
            values: { v1, v2, S, t },
            unknownVar,
            text,
            answer,
            unit
        };
    },

    same(fast, slow, unknown = 't') {
        let vF, vS;
        do {
            vF = this.random(fast.speed.min, fast.speed.max);
            vS = this.random(slow.speed.min, slow.speed.max);
        } while (vF <= vS + 5);
        const t = this.random(2, 4);
        const S = (vF - vS) * t;

        let text, answer, unit, unknownVar;

        switch(unknown) {
            case 't':
                text = `${slow.labels.cap} –¥–≤–∏–≥–∞–ª—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vS} –∫–º/—á</b>. –í–¥–æ–≥–æ–Ω–∫—É –µ–º—É –≤—ã–µ—Ö–∞–ª ${fast.labels.nom} —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vF} –∫–º/—á</b>. –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –æ–Ω –¥–æ–≥–æ–Ω–∏—Ç, –µ—Å–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –º–µ–∂–¥—É –Ω–∏–º–∏ –±—ã–ª–æ <b>${S} –∫–º</b>?`;
                answer = t;
                unit = "—á.";
                unknownVar = 't';
                break;
            case 'S':
                text = `${slow.labels.cap} –¥–≤–∏–≥–∞–ª—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vS} –∫–º/—á</b>. –í–¥–æ–≥–æ–Ω–∫—É –µ–º—É –≤—ã–µ—Ö–∞–ª ${fast.labels.nom} —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vF} –∫–º/—á</b>. –ö–∞–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±—ã–ª–æ –º–µ–∂–¥—É –Ω–∏–º–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –¥–æ–≥–Ω–∞–ª –æ–Ω —á–µ—Ä–µ–∑ <b>${t} —á</b>?`;
                answer = S;
                unit = "–∫–º";
                unknownVar = 'S';
                break;
            case 'vF':
                text = `${slow.labels.cap} –¥–≤–∏–≥–∞–ª—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vS} –∫–º/—á</b>. –í–¥–æ–≥–æ–Ω–∫—É –µ–º—É –≤—ã–µ—Ö–∞–ª ${fast.labels.nom} –∏ –¥–æ–≥–Ω–∞–ª —á–µ—Ä–µ–∑ <b>${t} —á</b>. –ö–∞–∫–æ–≤–∞ –±—ã–ª–∞ —Å–∫–æ—Ä–æ—Å—Ç—å ${fast.labels.gen}, –µ—Å–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –º–µ–∂–¥—É –Ω–∏–º–∏ –±—ã–ª–æ <b>${S} –∫–º</b>?`;
                answer = vF;
                unit = "–∫–º/—á";
                unknownVar = 'vF';
                break;
            case 'vS':
                text = `${slow.labels.cap} –¥–≤–∏–≥–∞–ª—Å—è —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é. –í–¥–æ–≥–æ–Ω–∫—É –µ–º—É –≤—ã–µ—Ö–∞–ª ${fast.labels.nom} —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${vF} –∫–º/—á</b> –∏ –¥–æ–≥–Ω–∞–ª —á–µ—Ä–µ–∑ <b>${t} —á</b>. –ö–∞–∫–æ–≤–∞ –±—ã–ª–∞ —Å–∫–æ—Ä–æ—Å—Ç—å ${slow.labels.gen}, –µ—Å–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –º–µ–∂–¥—É –Ω–∏–º–∏ –±—ã–ª–æ <b>${S} –∫–º</b>?`;
                answer = vS;
                unit = "–∫–º/—á";
                unknownVar = 'vS';
                break;
        }

        return {
            type: 'same',
            actors: { fast, slow },
            values: { vF, vS, S, t },
            unknownVar,
            text,
            answer,
            unit
        };
    },

    // –ù–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
    ratio(a, b, ratio, unknown = 't2') {
        // –í—ã–±–∏—Ä–∞–µ–º v1 —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ –¥–µ–ª–∏–ª–æ—Å—å –Ω–∞ ratio –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞
        let v1;
        do {
            v1 = this.random(a.speed.min, a.speed.max);
        } while (v1 % ratio !== 0);
        
        const t1 = this.random(2, 6);
        const S = v1 * t1;
        const t2 = t1 * ratio;
        const v2 = v1 / ratio; // —Ç–æ—á–Ω–æ –¥–µ–ª–∏—Ç—Å—è

        let text, answer, unit, unknownVar;

        switch(unknown) {
            case 't2':
                text = `${a.labels.cap} –±—ã–ª –≤ –ø—É—Ç–∏ <b>${t1} —á</b>, –¥–≤–∏–≥–∞—è—Å—å —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${v1} –∫–º/—á</b>. –ó–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–æ–µ—Ö–∞—Ç—å —ç—Ç–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${b.labels.nom}, –µ—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –±—É–¥–µ—Ç –≤ <b>${ratio}</b> —Ä–∞–∑ –º–µ–Ω—å—à–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ ${a.labels.gen}?`;
                answer = t2;
                unit = "—á.";
                unknownVar = 't2';
                break;
            case 'v2':
                text = `${a.labels.cap} –±—ã–ª –≤ –ø—É—Ç–∏ <b>${t1} —á</b>, –¥–≤–∏–≥–∞—è—Å—å —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${v1} –∫–º/—á</b>. –ö–∞–∫–æ–≤–∞ —Å–∫–æ—Ä–æ—Å—Ç—å ${b.labels.gen}, –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª —ç—Ç–æ –∂–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞ <b>${t2} —á</b>?`;
                answer = v2;
                unit = "–∫–º/—á";
                unknownVar = 'v2';
                break;
            case 'S':
                text = `${a.labels.cap} –¥–≤–∏–≥–∞–ª—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${v1} –∫–º/—á</b> –≤ —Ç–µ—á–µ–Ω–∏–µ <b>${t1} —á</b>. ${b.labels.cap} –ø—Ä–æ–µ—Ö–∞–ª —ç—Ç–æ –∂–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞ <b>${t2} —á</b>. –ö–∞–∫–æ–≤–æ —ç—Ç–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ?`;
                answer = S;
                unit = "–∫–º";
                unknownVar = 'S';
                break;
            case 'ratio':
                text = `${a.labels.cap} –±—ã–ª –≤ –ø—É—Ç–∏ <b>${t1} —á</b>, –¥–≤–∏–≥–∞—è—Å—å —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é <b>${v1} –∫–º/—á</b>. ${b.labels.cap} –ø—Ä–æ–µ—Ö–∞–ª —ç—Ç–æ –∂–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞ <b>${t2} —á</b>. –í–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–∫–æ—Ä–æ—Å—Ç—å ${a.labels.gen} –±–æ–ª—å—à–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ ${b.labels.gen}?`;
                answer = ratio;
                unit = "—Ä–∞–∑";
                unknownVar = 'ratio';
                break;
        }

        return {
            type: 'ratio',
            actors: { a, b },
            values: { v1, v2, S, t1, t2, ratio },
            unknownVar,
            text,
            answer,
            unit
        };
    }
};

/**
 * 3. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (SVG Drawing) - –°—Ç–∏–ª—å "–£—á–µ–±–Ω–∏–∫"
 */
const visualizer = {
    svg: document.getElementById('taskSvg'),
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª–µ–π (—Ü–≤–µ—Ç–∞ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤)
    colors: {
        path: '#004085',      // –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π –¥–ª—è –¥–æ—Ä–æ–≥–∏
        arrow: '#00BFFF',     // –ì–æ–ª—É–±–æ–π –¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫
        text: '#212529',      // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        flag: '#FF3333',      // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Ñ–ª–∞–≥–∞
        dot: '#004085'        // –¶–≤–µ—Ç —Ç–æ—á–µ–∫ –Ω–∞ –ª–∏–Ω–∏–∏
    },

    clear() { this.svg.innerHTML = ''; },

    // --- –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã ---

    // –°–æ–∑–¥–∞–Ω–∏–µ SVG —ç–ª–µ–º–µ–Ω—Ç–∞
    el(tag, attrs = {}) {
        const elem = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (let key in attrs) elem.setAttribute(key, attrs[key]);
        return elem;
    },

    // –†–∏—Å—É–µ—Ç –∂–∏—Ä–Ω—É—é –¥–æ—Ä–æ–≥—É
    drawPathLine(x1, x2, y) {
        this.svg.appendChild(this.el('line', {
            x1, y1: y, x2, y2: y,
            stroke: this.colors.path,
            'stroke-width': 4,
            'stroke-linecap': 'round'
        }));
    },

    // –†–∏—Å—É–µ—Ç —Ç–æ—á–∫—É –Ω–∞ –¥–æ—Ä–æ–≥–µ
    drawDot(x, y) {
        this.svg.appendChild(this.el('circle', {
            cx: x, cy: y, r: 4,
            fill: 'white',
            stroke: this.colors.dot,
            'stroke-width': 3
        }));
    },

    // –†–∏—Å—É–µ—Ç –∫—Ä–∞—Å–Ω—ã–π —Ñ–ª–∞–∂–æ–∫ (path)
    drawFlag(x, y) {
        const group = this.el('g', { transform: `translate(${x}, ${y - 22.5}) scale(0.5)` }); // –°–¥–≤–∏–≥ –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–æ–∂–∫–∞ —Å—Ç–æ—è–ª–∞ –Ω–∞ y, –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤ 2 —Ä–∞–∑–∞
        
        // –ù–æ–∂–∫–∞
        group.appendChild(this.el('line', {
            x1: 0, y1: 0, x2: 0, y2: 45,
            stroke: '#333', 'stroke-width': 2
        }));

        // –ü–æ–ª–æ—Ç–Ω–æ —Ñ–ª–∞–≥–∞ (–≤–æ–ª–Ω–æ–π)
        const flagPath = "M0,2 Q10,-3 20,2 T40,2 L40,22 Q30,17 20,22 T0,22 Z";
        group.appendChild(this.el('path', {
            d: flagPath,
            fill: this.colors.flag,
            stroke: '#cc0000',
            'stroke-width': 1
        }));

        this.svg.appendChild(group);
    },

    // –†–∏—Å—É–µ—Ç —Ñ–∏–≥—É—Ä–Ω—É—é —Å–∫–æ–±–∫—É —Å–Ω–∏–∑—É (–ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ)
    drawBrace(x1, x2, y, text) {
        const midX = (x1 + x2) / 2;
        const depth = 15; // –ì–ª—É–±–∏–Ω–∞ –ø—Ä–æ–≥–∏–±–∞
        
        // –†–∏—Å—É–µ–º "—É–ª—ã–±–∫—É" (–¥—É–≥—É)
        const pathData = `M ${x1} ${y+10} Q ${midX} ${y+10+depth} ${x2} ${y+10}`;
        
        this.svg.appendChild(this.el('path', {
            d: pathData,
            fill: 'none',
            stroke: '#333',
            'stroke-width': 1
        }));

        // –¢–µ–∫—Å—Ç –ø–æ–¥ —Å–∫–æ–±–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "?" –∏–ª–∏ "100 –∫–º")
        const textEl = this.el('text', {
            x: midX, y: y + 40,
            'text-anchor': 'middle',
            'font-family': 'Arial, sans-serif',
            'font-size': '16px',
            fill: this.colors.text
        });
        textEl.textContent = text;
        this.svg.appendChild(textEl);
    },

    // –†–∏—Å—É–µ—Ç —Å—Ç—Ä–µ–ª–∫—É —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é
    drawArrow(x, y, length, speedVal, direction = 'right') {
        const group = this.el('g');
        const endX = direction === 'right' ? x + length : x - length;
        const arrowY = y - 20; // –°—Ç—Ä–µ–ª–∫–∞ –≤–∏—Å–∏—Ç –Ω–∞–¥ –¥–æ—Ä–æ–≥–æ–π

        // –õ–∏–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–∏
        group.appendChild(this.el('line', {
            x1: x, y1: arrowY, x2: endX, y2: arrowY,
            stroke: this.colors.arrow, 'stroke-width': 3
        }));

        // –ù–∞–∫–æ–Ω–µ—á–Ω–∏–∫
        const headSize = 8;
        const headPoints = direction === 'right' 
            ? `${endX},${arrowY} ${endX-headSize},${arrowY-4} ${endX-headSize},${arrowY+4}`
            : `${endX},${arrowY} ${endX+headSize},${arrowY-4} ${endX+headSize},${arrowY+4}`;
        
        group.appendChild(this.el('polygon', {
            points: headPoints, fill: this.colors.arrow
        }));

        // –¢–µ–∫—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ (–ù–ê–î —Å—Ç—Ä–µ–ª–∫–æ–π)
        const textX = (x + endX) / 2;
        const textEl = this.el('text', {
            x: textX, y: arrowY - 8,
            'text-anchor': 'middle',
            'font-family': 'Arial, sans-serif',
            'font-size': '18px',
            'font-weight': 'bold',
            fill: '#333'
        });
        textEl.textContent = `${speedVal} –∫–º/—á`;
        group.appendChild(textEl);

        this.svg.appendChild(group);
    },

    // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò ---
    draw(task) {
        this.clear();
        
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const W = 600; // –®–∏—Ä–∏–Ω–∞ —Ö–æ–ª—Å—Ç–∞
        const cY = 120; // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–æ—Ä–æ–≥–∏
        const pad = 50; // –û—Ç—Å—Ç—É–ø—ã

        // 1. –†–∏—Å—É–µ–º —Å—Ö–µ–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if (task.type === 'meeting') {
            // –î–ª–∏–Ω–Ω–∞—è –¥–æ—Ä–æ–≥–∞
            this.drawPathLine(pad, W-pad, cY);
            
            // –¢–æ—á–∫–∏ –ê –∏ –ë
            this.drawDot(pad, cY);
            this.drawDot(W-pad, cY);
            
            // –§–ª–∞–∂–æ–∫ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ (–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏)
            this.drawFlag(W/2, cY);

            // –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É
            const v1Text = task.unknownVar === 'v1' ? '?' : task.values.v1;
            const v2Text = task.unknownVar === 'v2' ? '?' : task.values.v2;
            this.drawArrow(pad, cY, 120, v1Text, 'right');
            this.drawArrow(W-pad, cY, 120, v2Text, 'left');

            // –°–∫–æ–±–∫–∞ —Å–Ω–∏–∑—É (S)
            const sText = task.unknownVar === 'S' ? '?' : task.values.S;
            this.drawBrace(pad, W-pad, cY, `${sText} –∫–º`);
        } 
        else if (task.type === 'opposite') {
            // –î–æ—Ä–æ–≥–∞
            this.drawPathLine(pad, W-pad, cY);

            // –¢–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
            this.drawDot(W/2, cY);
            // –§–ª–∞–∂–æ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
            this.drawFlag(W/2, cY);

            // –°—Ç—Ä–µ–ª–∫–∏ –≤—Ä–æ–∑—å
            const v1Text = task.unknownVar === 'v1' ? '?' : task.values.v1;
            const v2Text = task.unknownVar === 'v2' ? '?' : task.values.v2;
            this.drawArrow(W/2, cY, 120, v1Text, 'left');
            this.drawArrow(W/2, cY, 120, v2Text, 'right');

            // –°–∫–æ–±–∫–∞ —Å–Ω–∏–∑—É (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)
            const sText = task.unknownVar === 'S' ? '?' : task.values.S;
            this.drawBrace(pad, W-pad, cY, `${sText} –∫–º`);
        } 
        else if (task.type === 'same') {
            // –†–∞—Å—á–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è
            const startFast = pad; 
            const startSlow = pad + 150; // –ú–µ–¥–ª–µ–Ω–Ω—ã–π –≤–ø–µ—Ä–µ–¥–∏
            const catchPoint = W - pad; // –¢–æ—á–∫–∞ –≤—Å—Ç—Ä–µ—á–∏ (—Ñ–ª–∞–≥)

            // –î–æ—Ä–æ–≥–∞
            this.drawPathLine(pad, W-pad, cY);

            // –¢–æ—á–∫–∏
            this.drawDot(startFast, cY); // –°—Ç–∞—Ä—Ç –±—ã—Å—Ç—Ä–æ–≥–æ
            this.drawDot(startSlow, cY); // –°—Ç–∞—Ä—Ç –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ
            this.drawDot(catchPoint, cY); // –§–∏–Ω–∏—à

            // –§–ª–∞–∂–æ–∫ –Ω–∞ —Ñ–∏–Ω–∏—à–µ
            this.drawFlag(catchPoint, cY);

            // –°—Ç—Ä–µ–ª–∫–∏ (–æ–±–µ –≤–ø—Ä–∞–≤–æ)
            // –ë—ã—Å—Ç—Ä—ã–π (–¥–ª–∏–Ω–Ω–µ–µ —Å—Ç—Ä–µ–ª–∫–∞)
            const vFText = task.unknownVar === 'vF' ? '?' : task.values.vF;
            const vSText = task.unknownVar === 'vS' ? '?' : task.values.vS;
            this.drawArrow(startFast, cY, 100, vFText, 'right');
            // –ú–µ–¥–ª–µ–Ω–Ω—ã–π (–∫–æ—Ä–æ—á–µ —Å—Ç—Ä–µ–ª–∫–∞, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–∞–ª—å—à–µ)
            this.drawArrow(startSlow, cY, 80, vSText, 'right');

            // –°–∫–æ–±–∫–∞ (–Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏)
            const sText = task.unknownVar === 'S' ? '?' : task.values.S;
            this.drawBrace(startFast, startSlow, cY, `${sText} –∫–º`);
        }
        else if (task.type === 'ratio') {
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞, –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            // —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–∫–æ—Ä–æ—Å—Ç—è–º–∏
            
            const startX = pad;
            const endX = W - pad;
            const midY = cY;
            
            // –î–æ—Ä–æ–≥–∞ (–æ–±—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)
            this.drawPathLine(startX, endX, midY);
            
            // –¢–æ—á–∫–∏ —Å—Ç–∞—Ä—Ç–∞ –∏ —Ñ–∏–Ω–∏—à–∞
            this.drawDot(startX, midY);
            this.drawDot(endX, midY);
            
            // –§–ª–∞–∂–æ–∫ –Ω–∞ —Ñ–∏–Ω–∏—à–µ
            this.drawFlag(endX, midY);
            
            // –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–µ–ª–∫–∞ - –±—ã—Å—Ç—Ä—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ (v1)
            const fastArrowLength = endX - startX - 20;
            const v1Text = task.unknownVar === 'v2' ? '?' : task.values.v1;
            this.drawArrow(startX, midY, fastArrowLength, v1Text, 'right');
            
            // –ù–∏–∂–Ω—è—è —Å—Ç—Ä–µ–ª–∫–∞ - –º–µ–¥–ª–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ (v2)
            // –°–º–µ—â–∞–µ–º –≤–Ω–∏–∑ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            const v2Text = task.unknownVar === 'v2' ? '?' : task.values.v2;
            this.drawArrow(startX, midY, fastArrowLength * 0.3, v2Text);
            
            // –°–∫–æ–±–∫–∞ —Å–Ω–∏–∑—É —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
            const sText = task.unknownVar === 'S' ? '?' : task.values.S;
            this.drawBrace(startX, endX, midY, `${sText} –∫–º`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
            const timeGroup = this.el('g', {
                'font-family': 'Arial, sans-serif',
                'font-size': '14px',
                fill: this.colors.text
            });
            
            // –í—Ä–µ–º—è –±—ã—Å—Ç—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            const fastTimeText = this.el('text', {
                x: startX + 80,
                y: midY - 70,
                'font-weight': 'bold',
                fill: '#0066cc'
            });
            fastTimeText.textContent = `t‚ÇÅ = ${task.values.t1} —á`;
            timeGroup.appendChild(fastTimeText);
            
            // –í—Ä–µ–º—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            const slowTimeText = this.el('text', {
                x: startX + 80,
                y: midY + 60,
                'font-weight': 'bold',
                fill: '#cc6600'
            });
            const t2Text = task.unknownVar === 't2' ? '?' : task.values.t2;
            slowTimeText.textContent = `t‚ÇÇ = ${t2Text} —á`;
            timeGroup.appendChild(slowTimeText);
            
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
            const ratioText = this.el('text', {
                x: W / 2,
                y: midY - 10,
                'text-anchor': 'middle',
                'font-size': '16px',
                'font-weight': 'bold',
                fill: '#e74c3c'
            });
            const ratioTextValue = task.unknownVar === 'ratio' ? '?' : task.values.ratio;
            ratioText.textContent = `√ó${ratioTextValue}`;
            timeGroup.appendChild(ratioText);
            
            // –õ–∏–Ω–∏—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å—Ç—Ä–µ–ª–∫–∞–º–∏
            if (task.unknownVar !== 'ratio') {
                const connectorLine = this.el('line', {
                    x1: W / 2,
                    y1: midY - 30,
                    x2: W / 2,
                    y2: midY + 10,
                    stroke: '#e74c3c',
                    'stroke-width': 2,
                    'stroke-dasharray': '4,4'
                });
                timeGroup.appendChild(connectorLine);
            }
            
            this.svg.appendChild(timeGroup);
        }
    }
};


/**
 * 4. –ò–ù–¢–ï–†–§–ï–ô–°
 */
const ui = {
    // –í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
    unknownOptions: {
        meeting: [
            { value: 't', label: '–í—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏ (t)' },
            { value: 'S', label: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (S)' },
            { value: 'v1', label: '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ (v‚ÇÅ)' },
            { value: 'v2', label: '–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ (v‚ÇÇ)' }
        ],
        opposite: [
            { value: 'S', label: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (S)' },
            { value: 't', label: '–í—Ä–µ–º—è (t)' },
            { value: 'v1', label: '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ (v‚ÇÅ)' },
            { value: 'v2', label: '–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ (v‚ÇÇ)' }
        ],
        same: [
            { value: 't', label: '–í—Ä–µ–º—è (t)' },
            { value: 'S', label: '–ù–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (S)' },
            { value: 'vF', label: '–°–∫–æ—Ä–æ—Å—Ç—å –¥–æ–≥–æ–Ω—è—é—â–µ–≥–æ (v‚ÇÅ)' },
            { value: 'vS', label: '–°–∫–æ—Ä–æ—Å—Ç—å —É–±–µ–≥–∞—é—â–µ–≥–æ (v‚ÇÇ)' }
        ],
        ratio: [
            { value: 't2', label: '–í—Ä–µ–º—è –≤—Ç–æ—Ä–æ–≥–æ (t‚ÇÇ)' },
            { value: 'v2', label: '–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ (v‚ÇÇ)' },
            { value: 'S', label: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (S)' },
            { value: 'ratio', label: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (k)' }
        ]
    },

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
    updateUnknownOptions() {
        const taskType = document.getElementById('taskType').value;
        const unknownSelect = document.getElementById('unknownVar');
        unknownSelect.innerHTML = '';
        
        this.unknownOptions[taskType].forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            unknownSelect.appendChild(opt);
        });
    },

    generate() {
        // –°–±—Ä–æ—Å UI
        document.getElementById('feedback').textContent = '';
        document.getElementById('userAnswer').value = '';
        document.querySelectorAll('.btn-exp').forEach(b => b.style.display = 'inline-block');

        const type = document.getElementById('taskType').value;
        const unknown = document.getElementById('unknownVar').value;

        // –í—ã–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –±–∞–∑—ã
        // –ö–ª–æ–Ω—ã (—Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º "2") –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞—Ä–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
        const baseActors = ACTORS_DB.filter(actor => !actor.id.endsWith('2'));
        const useSameType = Math.random() < 0.3; // 30% —à–∞–Ω—Å –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ç–∏–ø—ã
        
        let a, b;
        if (useSameType) {
            // –í—ã–±–∏—Ä–∞–µ–º –æ–¥–∏–Ω —Ç–∏–ø –∏ –±–µ—Ä—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –∫–ª–æ–Ω
            const baseActor = engine.pick(baseActors);
            a = baseActor;
            b = ACTORS_DB.find(actor => actor.id === baseActor.id + '2');
        } else {
            // –í—ã–±–∏—Ä–∞–µ–º –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞ (—Ç–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—ã)
            a = engine.pick(baseActors);
            b = engine.pick(baseActors);
            while (a.id === b.id) b = engine.pick(baseActors);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        if (type === 'same') {
            const sorted = [a, b].sort((x, y) => x.speed.max - y.speed.max);
            currentTaskData = engine.same(sorted[1], sorted[0], unknown); // fast, slow
        } else if (type === 'ratio') {
            // –î–ª—è ratio –≤—ã–±–∏—Ä–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç 2 –¥–æ 6
            const ratio = engine.random(2, 6);
            currentTaskData = engine.ratio(a, b, ratio, unknown);
        } else {
            currentTaskData = engine[type](a, b, unknown);
        }

        // –í—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
        document.getElementById('taskText').innerHTML = currentTaskData.text;
        document.getElementById('unitDisplay').textContent = currentTaskData.unit;
        
        // –†–∏—Å—É–µ–º —Å—Ö–µ–º—É
        visualizer.draw(currentTaskData);
    },

    check() {
        if(!currentTaskData) return;
        const userVal = parseInt(document.getElementById('userAnswer').value);
        const feedback = document.getElementById('feedback');
        
        if (userVal === currentTaskData.answer) {
            feedback.textContent = "‚úÖ –í–µ—Ä–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü!";
            feedback.className = 'feedback correct';
        } else {
            feedback.textContent = `‚ùå –û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${currentTaskData.answer}`;
            feedback.className = 'feedback wrong';
        }
    }
};

/**
 * 5. –≠–ö–°–ü–û–†–¢ (SVG –∏ PNG)
 */
const exporter = {
    // –•–µ–ª–ø–µ—Ä –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    triggerDownload(href, filename) {
        const link = document.createElement('a');
        link.href = href;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    saveSVG() {
        if (!currentTaskData) return;
        const svgData = document.getElementById('taskSvg').outerHTML;
        const svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
        const svgUrl = URL.createObjectURL(svgBlob);
        this.triggerDownload(svgUrl, `task_${currentTaskData.type}_${Date.now()}.svg`);
    },

    savePNG() {
        if (!currentTaskData) return;
        const svgElement = document.getElementById('taskSvg');
        const canvas = document.getElementById('pngCanvas');
        const ctx = canvas.getContext('2d');

        // 1. –ü–æ–ª—É—á–∞–µ–º SVG –¥–∞–Ω–Ω—ã–µ
        const svgData = new XMLSerializer().serializeToString(svgElement);
        // –î–æ–±–∞–≤–ª—è–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω, –∏–Ω–∞—á–µ PNG –±—É–¥–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
        const svgDataWithBg = svgData.replace('<svg', '<svg style="background-color: white;"');
        
        const img = new Image();
        // 2. –°–æ–∑–¥–∞–µ–º Blob –∏–∑ SVG –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Image
        const svgBlob = new Blob([svgDataWithBg], {type: "image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(svgBlob);

        img.onload = function() {
            // 3. –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Canvas –≤ PNG Data URL
            const pngUrl = canvas.toDataURL("image/png");
            exporter.triggerDownload(pngUrl, `task_${currentTaskData.type}_${Date.now()}.png`);
            
            URL.revokeObjectURL(url);
        };
        img.src = url;
    }
};
</script>

</body>
</html>